<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ร้านครัวแม่อร(ช่วงการทดสอบโปรแกรม)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        /* ตั้งค่าฟอนต์หลักให้เป็น 'Sarabun' (สำหรับภาษาไทย) และ 'Inter' เป็นฟอนต์สำรอง */
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
        }
        
        /* สไตล์ Scrollbar สำหรับตะกร้าสินค้า */
        #cart-items-container::-webkit-scrollbar,
        .admin-tab-content::-webkit-scrollbar {
            width: 8px;
        }
        #cart-items-container::-webkit-scrollbar-thumb,
        .admin-tab-content::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- =========== Header (ส่วนหัวของเว็บ) =========== -->
    <header class="sticky top-0 z-50 bg-white shadow-md">
        <nav class="container mx-auto flex justify-between items-center p-4">
            <!-- Logo / Brand Name -->
            <a href="#" class="text-3xl font-bold text-amber-600">ร้านครัวแม่อร (ช่วงการทดสอบโปรแกรม)</a>
            
            <!-- Action Buttons (Admin + Cart) -->
            <div class="flex gap-4">
                <!-- Admin Button -->
                <button id="open-admin-btn" class="flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold shadow-md hover:bg-gray-300 transition-colors">
                    <i data-lucide="shield" class="w-5 h-5"></i>
                    <span>Admin</span>
                </button>

                <!-- Cart Button (ปุ่มตะกร้า) -->
                <button id="open-cart-btn" class="flex items-center gap-2 px-4 py-2 bg-amber-500 text-white rounded-lg font-semibold shadow-md hover:bg-amber-600 transition-colors">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span>ตะกร้า</span>
                    <span id="cart-count" class="bg-amber-700 text-white text-xs font-bold rounded-full px-2 py-0.5">0</span>
                </button>
            </div>
        </nav>
    </header>

    <!-- =========== Main Content (ส่วนเนื้อหาหลัก) =========== -->
    <main class="container mx-auto p-4">

        <!-- Hero Section (ส่วนโปรโมต) -->
        <section class="relative bg-gray-800 text-white rounded-lg overflow-hidden shadow-xl mb-12">
            <img 
                src="https://static.cordonbleu.edu/Files/MediaFile/86673.jpg" 
                alt="อาหารไทยน่าทาน" 
                class="w-full h-64 object-cover opacity-50"
                onerror="this.src='https://placehold.co/1200x400/333333/FFFFFF?text=Image+Error'"
            >
            <div class="absolute inset-0 flex flex-col justify-center items-center text-center p-4">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">อาหารไทยราคาประหยัด อร่อยเต็มอิ่ม</h1>
                <p class="text-lg md:text-xl mb-6">เริ่มเพียง 2 บาท! เมนูตามสั่งรสเด็ด</p>
                <a href="#menu" class="px-6 py-3 bg-amber-500 text-white rounded-lg font-semibold shadow-lg hover:bg-amber-600 transition-colors text-lg">
                    ดูเมนูทั้งหมด
                </a>
            </div>
        </section>

        <!-- Menu Section (ส่วนเมนูอาหาร) -->
        <section id="menu">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-l-4 border-amber-500 pl-4">เมนูของเรา (Our Menu)</h2>
            <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Menu items will be generated by JavaScript -->
            </div>
        </section>

    </main>

    <!-- =========== Footer (ส่วนท้ายของเว็บ) =========== -->
    <footer class="bg-gray-800 text-gray-300 mt-12 py-6">
        <div class="container mx-auto text-center">
            <p>&copy; 2568 (2025) ร้านครัวแม่อร. สงวนลิขสิทธิ์.</p>
            <p class="text-sm">ออกแบบสำหรับเรียนรู้ HTML, CSS และ JavaScript</p>
        </div>
    </footer>

    <!-- =========== Cart Modal (หน้าต่างตะกร้าสินค้า) =========== -->
    <div id="cart-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-2xl font-bold text-gray-800">ตะกร้าสินค้าของคุณ</h3>
                <button id="close-cart-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>
            <div id="cart-items-container" class="overflow-y-auto p-4 flex-grow">
                <!-- Cart items will be inserted here by JavaScript -->
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-lg">
                <div class="flex justify-between text-lg font-semibold text-gray-700 mb-2">
                    <span>ราคารวมย่อย:</span>
                    <span id="cart-subtotal">฿0</span>
                </div>
                <div class="flex justify-between text-md text-gray-600 mb-2">
                    <span>ภาษี (7%):</span>
                    <span id="cart-tax">฿0</span>
                </div>
                <div class="flex justify-between text-2xl font-bold text-gray-900 mb-4">
                    <span>ยอดสุทธิ:</span>
                    <span id="cart-total">฿0</span>
                </div>
                <button id="checkout-btn" class="w-full py-3 bg-amber-500 text-white rounded-lg font-semibold text-lg shadow-md hover:bg-amber-600 transition-colors">
                    สั่งซื้อ
                </button>
            </div>
        </div>
    </div>
    
    <!-- =========== Checkout Details Modal (หน้าต่างกรอกที่อยู่) =========== -->
    <div id="checkout-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">กรอกรายละเอียดจัดส่ง</h3>
                <button id="close-checkout-details-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- Customer Name -->
                <div>
                    <label for="customer-name-input" class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้สั่ง</label>
                    <input type="text" id="customer-name-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500" placeholder="ชื่อ-นามสกุล">
                </div>
                <!-- Delivery Address -->
                <div>
                    <label for="delivery-address-input" class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่จัดส่ง / พิกัด Google Maps</label>
                    <textarea id="delivery-address-input" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500" placeholder="บ้านเลขที่, ถนน, ตำบล, หรือวางพิกัดจาก Google Maps"></textarea>
                    <p class="text-xs text-gray-500 mt-1">เพื่อให้ส่งได้แม่นยำที่สุด หากมีพิกัดจาก Google Maps สามารถวางได้เลย</p>
                </div>
            </div>
            <p id="details-error-msg" class="text-red-500 mb-4 mt-2 hidden">กรุณากรอกชื่อและที่อยู่ให้ครบถ้วน</p>
            <button id="confirm-order-btn" class="w-full mt-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">
                ยืนยันการสั่งซื้อ
            </button>
        </div>
    </div>

    <!-- =========== Admin Login Modal (หน้าต่างล็อกอิน Admin) =========== -->
    <div id="admin-login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">เข้าสู่ระบบ Admin</h3>
                <button id="close-admin-login-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="mb-4 text-gray-600">กรุณาใส่รหัสลับเพื่อเข้าสู่หน้า Admin:</p>
            <input type="password" id="admin-password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-amber-500 focus:border-amber-500" placeholder="รหัสลับ (Secret Code)">
            <p id="admin-login-error" class="text-red-500 mb-4 hidden">รหัสลับไม่ถูกต้อง</p>
            <button id="admin-login-btn" class="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                เข้าสู่ระบบ
            </button>
        </div>
    </div>

    <!-- =========== Admin Panel Modal (หน้า Admin) =========== -->
    <div id="admin-panel-modal" class="hidden fixed inset-0 bg-white z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg w-full max-w-4xl flex flex-col h-full md:max-h-[95vh] shadow-xl">
            <div class="flex justify-between items-center p-4 border-b bg-gray-50">
                <h3 class="text-2xl font-bold text-indigo-700">Admin Panel</h3>
                <button id="close-admin-panel-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Tab Navigation -->
            <div class="p-4 border-b bg-gray-100 flex gap-4">
                <button id="tab-orders" class="tab-button px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg">
                    <i data-lucide="clipboard-list" class="w-5 h-5 inline-block mr-1"></i> รายการคำสั่งซื้อ
                </button>
                <button id="tab-menu-management" class="tab-button px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400">
                    <i data-lucide="plus-circle" class="w-5 h-5 inline-block mr-1"></i> จัดการเมนู
                </button>
            </div>

            <!-- Tab Content: Orders -->
            <div id="admin-content-orders" class="admin-tab-content overflow-y-auto p-6 flex-grow">
                <p id="loading-orders-msg" class="text-center text-gray-500 mt-8">กำลังโหลดรายการคำสั่งซื้อ...</p>
                <!-- Orders will be rendered here -->
            </div>

            <!-- Tab Content: Menu Management (NEW) -->
            <div id="admin-content-menu" class="admin-tab-content hidden overflow-y-auto p-6 flex-grow">
                
                <h4 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">เพิ่มรายการอาหารใหม่</h4>
                <!-- Form to Add New Item -->
                <div class="bg-white p-4 rounded-lg shadow-md space-y-3 mb-8">
                    <input type="url" id="new-item-image" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="1. ลิงก์รูปภาพ (URL) เช่น https://..." required>
                    <input type="text" id="new-item-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="2. ชื่ออาหาร" required>
                    <textarea id="new-item-description" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="3. คำอธิบาย"></textarea>
                    <input type="number" id="new-item-price" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="4. ราคา (บาท)" required min="1">
                    <p id="menu-add-error" class="text-red-500 hidden">กรุณากรอกข้อมูลให้ครบถ้วนและราคาต้องมากกว่า 0</p>
                    <button id="add-new-item-btn" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg shadow-lg hover:bg-green-700 transition-colors">
                        เพิ่มรายการอาหาร
                    </button>
                </div>
                
                <h4 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">รายการอาหารที่เพิ่มโดย Admin (Custom Items)</h4>
                <div id="custom-menu-list" class="space-y-3">
                    <p class="text-gray-500 text-center">กำลังโหลดรายการที่เพิ่ม...</p>
                    <!-- Custom items will be rendered here -->
                </div>

            </div>
            
            <div class="p-4 border-t bg-gray-50">
                <p id="admin-status-msg" class="text-sm text-gray-600 text-center">กำลังเชื่อมต่อฐานข้อมูล...</p>
            </div>
        </div>
    </div>


    <!-- =========== Order Success Message (ข้อความขอบคุณ) =========== -->
    <div id="success-message" class="hidden fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-xl z-50">
        <p class="font-semibold">ขอบคุณสำหรับออเดอร์!</p>
        <p>เรากำลังเตรียมอาหารของคุณ</p>
    </div>


    <!-- =========== JavaScript (ส่วนของโค้ดที่ทำให้เว็บโต้ตอบได้) =========== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE VARIABLES (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const ADMIN_SECRET_CODE = 'iamnine999po';

        let db;
        let auth;
        let currentUserId = null;
        let isFirebaseReady = false;
        let isAdminLoggedIn = false;
        let unsubscribeOrders = null; 
        let unsubscribeCustomMenu = null; // New listener for custom menu items
        
        // Firestore Collection Paths
        const ORDERS_COLLECTION_PATH = `artifacts/${appId}/public/data/orders`;
        const CUSTOM_MENU_COLLECTION_PATH = `artifacts/${appId}/public/data/custom_items`;
        // ---------------------------------------------

        // --- 1. Database (ฐานข้อมูลเมนูอาหาร) ---
        // Hardcoded menu items
        const menuItems = [
            { 
                id: 1, 
                name: 'ผัดกะเพราหมูสับ (ราดข้าว)', 
                description: 'ผัดกะเพรารสจัดจ้าน เสิร์ฟพร้อมข้าวสวยร้อนๆ', 
                price: 40, 
                image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR1ygx9-XsOsK1qZ81o5wFPJYWWzGo1b-wDrg&s' 
            },
            { 
                id: 2, 
                name: 'ข้าวผัดหมู', 
                description: 'ข้าวผัดหมูจานด่วน หอมกลิ่นกระทะ', 
                price: 40, 
                image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSC1IHIJUkA6KV4TWAvvIb029pSqXbyH6FZUg&s' 
            },
            { 
                id: 3, 
                name: 'ไข่ดาว', 
                description: 'ไข่ดาวกรอบๆ สำหรับทานคู่กับทุกเมนู', 
                price: 10, 
                image: 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Fried_Egg_2.jpg' 
            },
            { 
                id: 4, 
                name: 'ข้าวไข่เจียวหมูสับ', 
                description: 'ไข่เจียวฟูๆ ใส่หมูสับ เสิร์ฟพร้อมข้าวสวยร้อนๆ', 
                price: 45, 
                image: 'https://assets.unileversolutions.com/recipes-v3/117867-default.jpg?im=Resize,width=1024,height=1024' 
            },
            { 
                id: 5, 
                name: 'ต้มจืดวุ้นเส้นหมูสับ', 
                description: 'ซุปใส่หมูสับและวุ้นเส้น รสกลมกล่อม', 
                price: 50, 
                image: 'https://www.eatthaihome.com/wp-content/uploads/2019/06/Tom-Jued-Woon-Sen-Thai-Glass-Noodle-Soup-6.jpg' 
            },
            { 
                id: 6, 
                name: 'ขนมถ้วยฟู', 
                description: 'ขนมถ้วยฟูชิ้นเล็กๆ หวานหอม เนื้อนุ่ม.', 
                price: 10, 
                image: 'https://s359.thaicdn.net/pagebuilder/484b878c-43a9-4a73-a229-3939438fe293.jpg' 
            },
        ];

        // --- 2. State (ตัวแปรเก็บสถานะของแอป) ---
        let cart = [];
        let orders = []; 
        let customMenuItems = []; // New state for dynamically added menu items

        // --- 3. DOM Elements (ตัวแปรอ้างอิงส่วนต่างๆ ของ HTML) ---
        const menuGrid = document.getElementById('menu-grid');
        const cartModal = document.getElementById('cart-modal');
        const openCartBtn = document.getElementById('open-cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartCount = document.getElementById('cart-count');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartSubtotalEl = document.getElementById('cart-subtotal');
        const cartTaxEl = document.getElementById('cart-tax');
        const cartTotalEl = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const successMessage = document.getElementById('success-message');

        const checkoutDetailsModal = document.getElementById('checkout-details-modal');
        const closeCheckoutDetailsBtn = document.getElementById('close-checkout-details-btn');
        const customerNameInput = document.getElementById('customer-name-input');
        const deliveryAddressInput = document.getElementById('delivery-address-input');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const detailsErrorMsg = document.getElementById('details-error-msg');
        
        const adminLoginModal = document.getElementById('admin-login-modal');
        const openAdminBtn = document.getElementById('open-admin-btn');
        const closeAdminLoginBtn = document.getElementById('close-admin-login-btn');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLoginError = document.getElementById('admin-login-error');

        const adminPanelModal = document.getElementById('admin-panel-modal');
        const closeAdminPanelBtn = document.getElementById('close-admin-panel-btn');
        const adminOrdersContainer = document.getElementById('admin-content-orders');
        const adminStatusMsg = document.getElementById('admin-status-msg');
        const loadingOrdersMsg = document.getElementById('loading-orders-msg');
        
        // New Admin Panel Elements for Menu Management
        const tabOrders = document.getElementById('tab-orders');
        const tabMenuManagement = document.getElementById('tab-menu-management');
        const contentOrders = document.getElementById('admin-content-orders');
        const contentMenu = document.getElementById('admin-content-menu');
        const addNewItemBtn = document.getElementById('add-new-item-btn');
        const customMenuListEl = document.getElementById('custom-menu-list');

        // --- 4. Firebase Initialization ---
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUserId = user.uid;
                        } else {
                            currentUserId = crypto.randomUUID(); 
                        }
                        isFirebaseReady = true;
                        adminStatusMsg.textContent = `ฐานข้อมูลพร้อมใช้งาน (User: ${currentUserId.substring(0, 8)}...)`;
                        console.log("Firebase Ready. User ID:", currentUserId);
                    });
                } else {
                    console.error("Firebase configuration is missing. Orders will not be saved.");
                    isFirebaseReady = true;
                    adminStatusMsg.textContent = 'คำเตือน: ไม่สามารถบันทึกคำสั่งซื้อได้ (No Firebase Config)';
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                isFirebaseReady = true;
                adminStatusMsg.textContent = 'ข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล';
            }
        }

        // --- 5. Functions (ฟังก์ชันการทำงานต่างๆ) ---

        /**
         * ฟังก์ชันสำหรับโหลดรายการอาหารที่สร้างโดย Admin จาก Firestore
         */
        function loadCustomMenu() {
            if (!isFirebaseReady || !db) return;
            
            if (unsubscribeCustomMenu) {
                unsubscribeCustomMenu();
            }
            
            const customMenuRef = collection(db, CUSTOM_MENU_COLLECTION_PATH);
            const customMenuQuery = query(customMenuRef);

            unsubscribeCustomMenu = onSnapshot(customMenuQuery, (snapshot) => {
                customMenuItems = [];
                snapshot.forEach(doc => {
                    customMenuItems.push({ id: doc.id, ...doc.data() });
                });
                
                // อัปเดตเมนูหลักทันทีที่รายการอาหารเปลี่ยนแปลง
                renderMenu(); 
                
                // หากหน้า Admin เปิดอยู่ ให้อัปเดตรายการเมนูที่สร้างใหม่ด้วย
                if (!adminPanelModal.classList.contains('hidden')) {
                    renderCustomMenuList();
                }
                
            }, (error) => {
                console.error("Error loading custom menu:", error);
            });
        }

        /**
         * ฟังก์ชันสำหรับสร้างการ์ดเมนูอาหารแต่ละอัน
         */
        function renderMenu() {
            menuGrid.innerHTML = '';
            
            // รวมเมนูหลักและเมนูที่สร้างโดย Admin
            const combinedMenu = [...menuItems, ...customMenuItems]; 

            if (combinedMenu.length === 0) {
                 menuGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full py-10">ยังไม่มีรายการอาหารในเมนู</p>';
                 return;
            }

            combinedMenu.forEach(item => {
                // ใช้ ID (เลข) สำหรับเมนูหลัก หรือ Doc ID (สตริง) สำหรับเมนูที่เพิ่มใหม่
                const dataId = item.id; 

                const card = `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl">
                        <img 
                            src="${item.image}" 
                            alt="${item.name}" 
                            class="w-full h-48 object-cover" 
                            onerror="this.src='https://placehold.co/400x300/CCCCCC/333333?text=${item.name.substring(0, 10)}...'">
                        <div class="p-4">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h3>
                            <p class="text-gray-600 mb-4 h-12">${item.description}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-xl font-bold text-amber-600">฿${item.price}</span>
                                <button 
                                    class="add-to-cart-btn px-4 py-2 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600 transition-colors"
                                    data-id="${dataId}"
                                >
                                    เพิ่มลงตะกร้า
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                menuGrid.innerHTML += card;
            });
            // Re-render icons after dynamic content update
            lucide.createIcons();
        }

        /**
         * ฟังก์ชันสำหรับอัปเดตการแสดงผลตะกร้าสินค้า
         */
        function renderCart() {
            cartItemsContainer.innerHTML = '';
            let subtotal = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">ยังไม่มีสินค้าในตะกร้า</p>';
            } else {
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    
                    const cartItemHTML = `
                        <div class="flex justify-between items-center mb-4 p-2 rounded-lg bg-gray-50">
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${item.name}</p>
                                <p class="text-gray-600">฿${item.price} x ${item.quantity}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold text-gray-800">฿${itemTotal.toFixed(2)}</span>
                                <button class="remove-from-cart-btn text-red-500 hover:text-red-700" data-id="${item.id}">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.innerHTML += cartItemHTML;
                });
            }

            const tax = subtotal * 0.07;
            const total = subtotal + tax;

            cartSubtotalEl.textContent = `฿${subtotal.toFixed(2)}`;
            cartTaxEl.textContent = `฿${tax.toFixed(2)}`;
            cartTotalEl.textContent = `฿${total.toFixed(2)}`;
            
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            
            // Re-render icons after dynamic content update
            lucide.createIcons(); 
        }

        /**
         * ฟังก์ชันสำหรับเพิ่มของลงตะกร้า
         * @param {number|string} itemId - ID ของสินค้า (อาจเป็น number หรือ string จาก Firestore doc ID)
         */
        function addToCart(itemId) {
            const combinedMenu = [...menuItems, ...customMenuItems];
            const itemToAdd = combinedMenu.find(item => item.id == itemId); 
            const existingItem = cart.find(item => item.id == itemId);

            if (itemToAdd) { 
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({

                        
                        id: itemToAdd.id,
                        name: itemToAdd.name,
                        price: itemToAdd.price,
                        quantity: 1
                    });
                }
                renderCart();
            }
        }

        /**
         * ฟังก์ชันสำหรับลบของออกจากตะกร้า
         * @param {number|string} itemId - ID ของสินค้า (อาจเป็น number หรือ string จาก Firestore doc ID)
         */
        function removeFromCart(itemId) {
            const itemIndex = cart.findIndex(item => item.id == itemId);

            if (itemIndex > -1) {
                const item = cart[itemIndex];
                item.quantity--;

                if (item.quantity === 0) {
                    cart.splice(itemIndex, 1);
                }
            }
            renderCart();
        }
        
        /**
         * ฟังก์ชันสำหรับเปิด/ปิดหน้าต่างตะกร้า
         */
        function toggleCartModal() {
            cartModal.classList.toggle('hidden');
        }

        /**
         * ฟังก์ชันสำหรับบันทึกคำสั่งซื้อไปยัง Firestore
         */
        async function saveOrderToDatabase(orderData) {
            if (!isFirebaseReady || !db) {
                console.error("Database is not ready. Order not saved.");
                return;
            }
            try {
                const ordersCollectionRef = collection(db, ORDERS_COLLECTION_PATH);
                await addDoc(ordersCollectionRef, {
                    ...orderData,
                    timestamp: serverTimestamp(),
                    userId: currentUserId,
                });
                console.log("Order saved successfully!");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        /**
         * ฟังก์ชันสำหรับเปิด Modal กรอกรายละเอียดการจัดส่ง
         */
        function handleCheckout() {
            if (cart.length === 0) {
                console.warn("Cart is empty. Cannot checkout.");
                const cartFooter = checkoutBtn.parentElement;
                let errorMsg = cartFooter.querySelector('.cart-error');
                if (!errorMsg) {
                    errorMsg = document.createElement('p');
                    errorMsg.className = 'cart-error text-red-500 text-center mb-2';
                    cartFooter.prepend(errorMsg);
                }
                errorMsg.textContent = 'ตะกร้าของคุณว่างเปล่า';
                setTimeout(() => {
                    errorMsg.remove();
                }, 2000);
                return;
            }

            cartModal.classList.add('hidden');
            checkoutDetailsModal.classList.remove('hidden');
            customerNameInput.focus();
        }

        /**
         * ฟังก์ชันสำหรับยืนยันการสั่งซื้อจาก Modal รายละเอียด
         */
        async function handleConfirmOrder() {
            const customerName = customerNameInput.value.trim();
            const deliveryAddress = deliveryAddressInput.value.trim();
            const total = parseFloat(cartTotalEl.textContent.replace('฿', ''));

            if (!customerName || !deliveryAddress) {
                detailsErrorMsg.classList.remove('hidden');
                setTimeout(() => {
                    detailsErrorMsg.classList.add('hidden');
                }, 3000);
                return;
            }

            const orderData = {
                items: cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                total: total,
                customerName: customerName, 
                deliveryAddress: deliveryAddress,
            };

            await saveOrderToDatabase(orderData);

            checkoutDetailsModal.classList.add('hidden');
            successMessage.classList.remove('hidden');
            
            customerNameInput.value = '';
            deliveryAddressInput.value = '';
            cart = [];
            renderCart();
            
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 3000);
        }

        // --- 6. Admin Panel Functions ---

        /**
         * จัดการการล็อกอิน Admin ด้วยรหัสลับ
         */
        function handleAdminLogin() {
            const password = adminPasswordInput.value;
            if (password === ADMIN_SECRET_CODE) {
                isAdminLoggedIn = true;
                adminLoginModal.classList.add('hidden');
                adminPanelModal.classList.remove('hidden');
                setupAdminTabs(); // Setup tabs and load initial data
            } else {
                adminLoginError.classList.remove('hidden');
                adminPasswordInput.value = '';
                setTimeout(() => {
                    adminLoginError.classList.add('hidden');
                }, 3000);
            }
        }
        
        /**
         * จัดการการสลับ Tab ใน Admin Panel
         */
        function setupAdminTabs() {
            // Function to switch active tab
            function switchTab(target) {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.replace('bg-indigo-600', 'bg-gray-300'));
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.replace('text-white', 'text-gray-800'));
                document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.add('hidden'));

                if (target === 'orders') {
                    tabOrders.classList.replace('bg-gray-300', 'bg-indigo-600');
                    tabOrders.classList.replace('text-gray-800', 'text-white');
                    contentOrders.classList.remove('hidden');
                    renderAdminPanel(); // Load real-time orders
                } else if (target === 'menu') {
                    tabMenuManagement.classList.replace('bg-gray-300', 'bg-indigo-600');
                    tabMenuManagement.classList.replace('text-gray-800', 'text-white');
                    contentMenu.classList.remove('hidden');
                    renderCustomMenuList(); // Load real-time custom menu list
                }
            }
            
            tabOrders.onclick = () => switchTab('orders');
            tabMenuManagement.onclick = () => switchTab('menu');
            
            // Set initial tab to Orders when panel opens
            switchTab('orders'); 
            lucide.createIcons();
        }

        /**
         * แสดงรายการคำสั่งซื้อใน Admin Panel (Real-time with onSnapshot)
         */
        function renderAdminPanel() {
            if (!isFirebaseReady || !db) {
                loadingOrdersMsg.textContent = "ไม่สามารถเชื่อมต่อฐานข้อมูลได้";
                return;
            }
            
            if (unsubscribeOrders) {
                unsubscribeOrders();
            }

            loadingOrdersMsg.classList.remove('hidden');
            contentOrders.innerHTML = '';
            
            const ordersCollectionRef = collection(db, ORDERS_COLLECTION_PATH);
            const ordersQuery = query(ordersCollectionRef);

            unsubscribeOrders = onSnapshot(ordersQuery, (snapshot) => {
                orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });

                orders.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                contentOrders.innerHTML = ''; 
                loadingOrdersMsg.classList.add('hidden');

                if (orders.length === 0) {
                    contentOrders.innerHTML = '<p class="text-center text-gray-500 mt-8">ยังไม่มีคำสั่งซื้อ</p>';
                    return;
                }

                orders.forEach(order => {
                    const date = order.timestamp ? new Date(order.timestamp.seconds * 1000).toLocaleString('th-TH') : 'N/A';
                    const itemsList = order.items.map(item => 
                        `<li class="text-sm text-gray-700">${item.name} (x${item.quantity}) - ฿${item.price}</li>`
                    ).join('');

                    const customerInfo = `
                        <p class="text-gray-800"><strong>ชื่อลูกค้า:</strong> ${order.customerName || 'N/A'}</p>
                        <p class="text-gray-800 mb-2"><strong>ที่อยู่จัดส่ง:</strong> <span class="break-words">${order.deliveryAddress || 'N/A'}</span></p>
                    `;

                    const orderCard = `
                        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-lg shadow-md mb-4">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="text-xl font-bold text-indigo-800">ออเดอร์ #${order.id.substring(0, 8)}</h4>
                                <span class="text-sm font-semibold text-gray-600">${date}</span>
                            </div>
                            ${customerInfo}
                            <p class="text-gray-600 mb-2"><strong>User ID:</strong> ${order.userId}</p>
                            <h5 class="font-semibold mt-3 mb-1">รายการสินค้า:</h5>
                            <ul class="list-disc list-inside ml-2">${itemsList}</ul>
                            <div class="mt-4 pt-2 border-t border-indigo-200 flex justify-between">
                                <span class="text-lg font-bold text-indigo-800">ยอดรวม:</span>
                                <span class="text-lg font-bold text-indigo-800">฿${order.total.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                    contentOrders.innerHTML += orderCard;
                });
            }, (error) => {
                console.error("Error listening to orders:", error);
                loadingOrdersMsg.textContent = "ข้อผิดพลาดในการโหลดคำสั่งซื้อ";
            });
        }
        
        /**
         * แสดงรายการอาหารที่เพิ่มโดย Admin ในส่วนจัดการเมนู
         */
        function renderCustomMenuList() {
            customMenuListEl.innerHTML = '';

            if (customMenuItems.length === 0) {
                customMenuListEl.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่มีรายการอาหารที่เพิ่มจาก Admin</p>';
                return;
            }

            customMenuItems.forEach(item => {
                const itemHtml = `
                    <div class="p-3 border rounded-lg flex justify-between items-center bg-white shadow-sm">
                        <div class="flex items-center gap-3">
                            <img 
                                src="${item.image}" 
                                class="w-10 h-10 object-cover rounded" 
                                onerror="this.src='https://placehold.co/40x40/CCCCCC/333333?text=N/A'"
                            >
                            <div>
                                <p class="font-semibold text-gray-800">${item.name} - ฿${item.price}</p>
                                <p class="text-sm text-gray-500 truncate w-48">${item.description}</p>
                            </div>
                        </div>
                        <button class="text-red-500 hover:text-red-700 delete-custom-item" data-id="${item.id}">
                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                customMenuListEl.innerHTML += itemHtml;
            });
            lucide.createIcons();
        }

        /**
         * ฟังก์ชันสำหรับเพิ่มรายการอาหารใหม่เข้า Firestore
         */
        async function handleAddItem() {
            const image = document.getElementById('new-item-image').value.trim();
            const name = document.getElementById('new-item-name').value.trim();
            const description = document.getElementById('new-item-description').value.trim();
            const price = parseFloat(document.getElementById('new-item-price').value);
            const errorMsgEl = document.getElementById('menu-add-error');

            if (!image || !name || !description || isNaN(price) || price <= 0) {
                errorMsgEl.classList.remove('hidden');
                return;
            }
            errorMsgEl.classList.add('hidden');

            if (!isFirebaseReady || !db) {
                adminStatusMsg.textContent = '❌ ฐานข้อมูลไม่พร้อมใช้งาน';
                return;
            }
            
            try {
                const customMenuRef = collection(db, CUSTOM_MENU_COLLECTION_PATH);
                await addDoc(customMenuRef, {
                    name: name,
                    description: description,
                    price: price,
                    image: image,
                    createdAt: serverTimestamp(),
                    createdBy: currentUserId
                });
                
                // Clear inputs after success
                document.getElementById('new-item-image').value = '';
                document.getElementById('new-item-name').value = '';
                document.getElementById('new-item-description').value = '';
                document.getElementById('new-item-price').value = '';

                adminStatusMsg.textContent = `✅ เพิ่ม "${name}" สำเร็จ!`;
                setTimeout(() => adminStatusMsg.textContent = `ฐานข้อมูลพร้อมใช้งาน (User: ${currentUserId.substring(0, 8)}...)`, 3000);

            } catch (e) {
                console.error("Error adding custom item: ", e);
                adminStatusMsg.textContent = '❌ ข้อผิดพลาดในการเพิ่มเมนู';
            }
        }
        
        /**
         * ฟังก์ชันสำหรับลบรายการอาหารที่สร้างโดย Admin
         */
        async function handleDeleteCustomItem(itemId) {
            if (!isFirebaseReady || !db) {
                adminStatusMsg.textContent = '❌ ฐานข้อมูลไม่พร้อมใช้งาน';
                return;
            }
            
            const itemToDelete = customMenuItems.find(item => item.id === itemId)?.name || 'รายการ';

            try {
                const itemDocRef = doc(db, CUSTOM_MENU_COLLECTION_PATH, itemId);
                await deleteDoc(itemDocRef);
                adminStatusMsg.textContent = `✅ ลบรายการ "${itemToDelete}" สำเร็จ!`;
                setTimeout(() => adminStatusMsg.textContent = `ฐานข้อมูลพร้อมใช้งาน (User: ${currentUserId.substring(0, 8)}...)`, 3000);
            } catch (e) {
                console.error("Error deleting document: ", e);
                adminStatusMsg.textContent = '❌ ข้อผิดพลาดในการลบรายการ';
            }
        }


        // --- 7. Event Listeners ---

        window.addEventListener('load', async () => {
            // Initialize Firebase first
            await initializeFirebase();
            loadCustomMenu(); // Start listening for custom menu items
            
            // Then run client-side UI setup
            lucide.createIcons();
            renderMenu();
            renderCart();

            // Cart Events
            openCartBtn.addEventListener('click', toggleCartModal);
            closeCartBtn.addEventListener('click', toggleCartModal);
            checkoutBtn.addEventListener('click', handleCheckout); 
            confirmOrderBtn.addEventListener('click', handleConfirmOrder); 
            closeCheckoutDetailsBtn.addEventListener('click', () => {
                checkoutDetailsModal.classList.add('hidden');
            });

            menuGrid.addEventListener('click', (event) => {
                if (event.target.classList.contains('add-to-cart-btn')) {
                    const id = event.target.getAttribute('data-id'); // Get ID as string/number
                    addToCart(id);
                }
            });
            cartItemsContainer.addEventListener('click', (event) => {
                const removeButton = event.target.closest('.remove-from-cart-btn');
                if (removeButton) {
                    const id = removeButton.getAttribute('data-id'); // Get ID as string/number
                    removeFromCart(id);
                }
            });

            // Admin Events
            openAdminBtn.addEventListener('click', () => {
                adminLoginModal.classList.remove('hidden');
                adminPasswordInput.focus();
            });
            closeAdminLoginBtn.addEventListener('click', () => {
                adminLoginModal.classList.add('hidden');
            });
            adminLoginBtn.addEventListener('click', handleAdminLogin);
            adminPasswordInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    handleAdminLogin();
                }
            });

            closeAdminPanelBtn.addEventListener('click', () => {
                adminPanelModal.classList.add('hidden');
                isAdminLoggedIn = false;
                
                // Stop all Firestore Listeners when closing Admin Panel
                if (unsubscribeOrders) {
                    unsubscribeOrders();
                    unsubscribeOrders = null;
                }
                if (unsubscribeCustomMenu) {
                    unsubscribeCustomMenu();
                    unsubscribeCustomMenu = null;
                }
            });
            
            // NEW: Menu Management Event Listeners
            addNewItemBtn.addEventListener('click', handleAddItem);
            
            // Listener for dynamically created delete buttons
            contentMenu.addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-custom-item');
                if (deleteButton) {
                    const id = deleteButton.getAttribute('data-id');
                    handleDeleteCustomItem(id);
                }
            });
        });
    </script>
</body>
</html>
